# Issue 2: Multi-Node TOML Parsing and Markdown Integration

**Priority**: CRITICAL - Blocks Issue 4  
**Estimated Effort**: 4-5 days  
**Dependencies**: Requires Issue 1 (Schema Registry)

## Summary

Enable TOML frontmatter to define metadata for multiple nodes (document + sections) and merge with nodes generated by markdown heading structure. Allows section-level schema payloads without polluting markdown content.

## Goals

1. Parse frontmatter with `sections` map defining per-heading metadata
2. Match section metadata to heading-generated nodes (by BID/anchor/title)
3. Apply schema-typed payloads to sections
4. Maintain clean separation: frontmatter = metadata, markdown = content

## Architecture

### Frontmatter Structure

```yaml
---
bid: doc-abc123
schema: Procedure

sections:
  "bid://intro-abc123":    # Explicit BID
    schema: Archetype
    payload:
      complexity: high
  
  "introduction":          # Title/anchor match
    schema: Archetype
---

# My Document

## Introduction {#bid://intro-abc123}
```

### Matching Strategy

Priority: BID URL > Anchor ID > Title slug

```rust
struct DocumentFrontmatter {
    // Document-level
    pub bid: Option<Bid>,
    pub schema: Option<String>,
    pub payload: Option<TomlTable>,
    
    // Section-level
    pub sections: HashMap<String, SectionMetadata>,
}

struct SectionMetadata {
    pub bid: Option<Bid>,
    pub schema: Option<String>,
    pub payload: Option<TomlTable>,
}
```

## Implementation Steps

1. **Parse Frontmatter with Sections** (1.5 days)
   - [ ] Define `DocumentFrontmatter` and `SectionMetadata` structs
   - [ ] Parse YAML with `sections` map
   - [ ] Validate section keys (BID/anchor/title format)

2. **Store Pending Sections** (0.5 days)
   - [ ] Add `frontmatter` field to `MdCodec`
   - [ ] Track section metadata separately during parse

3. **Match Sections to Headings** (1.5 days)
   - [ ] Implement matching logic during heading parse
   - [ ] Apply schema and payload when matched
   - [ ] Mark sections as matched

4. **Handle Unmatched Sections** (0.5 days)
   - [ ] Log warnings for unmatched sections
   - [ ] Optionally return diagnostics

5. **Multi-Node TOML Generation** (1 day, Optional)
   - [ ] Enable TOML codec to generate multiple nodes
   - [ ] `flatten_to_nodes()` method on `ProtoBeliefNode`

## Testing Requirements

- Parse frontmatter with/without sections
- Match by BID, anchor, title
- Section schema applied to heading nodes
- Unmatched sections logged as warnings
- Round-trip preservation

## Success Criteria

- [ ] Frontmatter defines section metadata
- [ ] Sections matched to headings by BID/anchor/title
- [ ] Section schema/payload applied correctly
- [ ] Unmatched sections warned (not errors)
- [ ] Backward compatible
- [ ] Tests pass

## Risks

**Risk**: Matching ambiguity (duplicate titles)  
**Mitigation**: Prefer BID URLs for explicit matching, warn on ambiguity

**Risk**: Schema validation complexity  
**Mitigation**: Make validation optional, log warnings for unknown schemas

**Risk**: Performance with many sections  
**Mitigation**: Build index once, O(1) lookup

## Open Questions

1. Unmatched sections: errors or warnings? (Recommend: warnings)
2. Support nested subsections? (Defer to Phase 2)
3. Schema validation timing? (During `traverse_schema()`)

## References

- Current parser: `codec/md.rs`
- TOML parsing: `codec/lattice_toml.rs`
- Schema migration: `utilities/schema_migration_notes.md`
