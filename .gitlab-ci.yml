# GitLab CI/CD Pipeline for noet-core
# Minimal configuration - GitHub is primary CI/CD
# GitLab role: Security scanning and namespace reservation

stages:
  - security
  - docs

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_BACKTRACE: "1"

# Security scanning (GitLab's strength)
sast:
  stage: security
  allow_failure: false

secret_detection:
  stage: security
  allow_failure: false

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

# Dependency audit (backup to GitHub's Dependabot)
audit:
  stage: security
  image: rust:latest
  before_script:
    - cargo install cargo-audit
  script:
    - cargo audit
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true # Advisory notices shouldn't block CI

# Optional: GitLab Pages for documentation backup
pages:
  stage: docs
  image: rust:latest
  cache:
    key:
      files:
        - Cargo.lock
      prefix: $CI_JOB_NAME
    paths:
      - .cargo/
      - target/
  script:
    - cargo doc --no-deps --all-features
    - mv target/doc public
    - echo '<meta http-equiv="refresh" content="0; url=noet_core">' > public/index.html
  artifacts:
    paths:
      - public
  only:
    - main
  allow_failure: true

# Note: Mirroring is handled by GitHub Actions
# GitHub pushes to GitLab on main/tags for backup and namespace reservation
